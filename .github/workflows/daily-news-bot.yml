# GitHub Actions ì›Œí¬í”Œë¡œìš° íŒŒì¼
# ê²½ë¡œ: .github/workflows/daily-news-bot.yml

name: ğŸ­ Daily News Bot

on:
  # ë§¤ì¼ ì˜¤ì „ 8ì‹œ (í•œêµ­ì‹œê°„) ìë™ ì‹¤í–‰ = UTC 23ì‹œ
  schedule:
    - cron: '0 23 * * *'
  
  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥ (GitHub Actions íƒ­ì—ì„œ Run workflow ë²„íŠ¼)
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì‹¤í–‰'
        required: false
        default: 'false'
        type: boolean

jobs:
  send-daily-news:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # 10ë¶„ íƒ€ì„ì•„ì›ƒ
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    # 2. Python í™˜ê²½ ì„¤ì •
    - name: ğŸ Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    # 4. í™˜ê²½ ë³€ìˆ˜ í™•ì¸
    - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ í™•ì¸
      run: |
        echo "ë„¤ì´ë²„ API í‚¤: ${{ secrets.NAVER_CLIENT_ID != '' && 'âœ… ì„¤ì •ë¨' || 'âŒ ëˆ„ë½' }}"
        echo "Gemini API í‚¤: ${{ secrets.GEMINI_API_KEY != '' && 'âœ… ì„¤ì •ë¨' || 'âŒ ëˆ„ë½' }}"
        echo "ì¹´ì¹´ì˜¤ API í‚¤: ${{ secrets.KAKAO_API_KEY != '' && 'âœ… ì„¤ì •ë¨' || 'âš ï¸ í…ŒìŠ¤íŠ¸ ëª¨ë“œ' }}"
        echo "ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S %Z')"
    
    # 5. Daily News Bot ì‹¤í–‰
    - name: ğŸš€ Daily News Bot ì‹¤í–‰
      env:
        NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
        NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        KAKAO_API_KEY: ${{ secrets.KAKAO_API_KEY }}
        TEST_MODE: ${{ github.event.inputs.test_mode }}
      run: |
        echo "ğŸŒ… Daily News Bot ì‹œì‘..."
        python daily_news_bot.py
    
    # 6. ì‹¤í–‰ ê²°ê³¼ ì—…ë¡œë“œ (ë””ë²„ê¹…ìš©)
    - name: ğŸ“¤ ì‹¤í–‰ ê²°ê³¼ ì—…ë¡œë“œ
      if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰
      uses: actions/upload-artifact@v3
      with:
        name: daily-news-result-${{ github.run_number }}
        path: |
          daily_news_result.json
          *.log
        retention-days: 7  # 7ì¼ê°„ ë³´ê´€
    
    # 7. ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
    - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      if: always()
      run: |
        echo "ğŸ“‹ ì‹¤í–‰ ê²°ê³¼ ìš”ì•½"
        echo "================="
        if [ -f "daily_news_result.json" ]; then
          echo "âœ… ê²°ê³¼ íŒŒì¼ ìƒì„±ë¨"
          # JSONì—ì„œ ì£¼ìš” ì •ë³´ ì¶”ì¶œ
          python -c "
          import json
          try:
              with open('daily_news_result.json', 'r') as f:
                  data = json.load(f)
              
              print(f'ë‰´ìŠ¤ ìˆ˜ì§‘: {data.get(\"statistics\", {}).get(\"news_count\", 0)}ê°œ')
              print(f'ë°œì†¡ ì„±ê³µë¥ : {data.get(\"statistics\", {}).get(\"success_rate\", 0):.1f}%')
              print(f'ë©”ì‹œì§€ ê¸¸ì´: {data.get(\"statistics\", {}).get(\"total_characters\", 0)}ì')
              print(f'ì‹¤í–‰ ìƒíƒœ: {data.get(\"execution_log\", {}).get(\"status\", \"unknown\")}')
          except Exception as e:
              print(f'ê²°ê³¼ íŒŒì‹± ì˜¤ë¥˜: {e}')
          "
        else
          echo "âŒ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
        fi
    
    # 8. ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    - name: ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼
      if: failure()
      run: |
        echo "âŒ Daily News Bot ì‹¤í–‰ ì‹¤íŒ¨!"
        echo "GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        echo "Repository â†’ Actions â†’ í•´ë‹¹ ì›Œí¬í”Œë¡œìš° â†’ ë¡œê·¸ í™•ì¸"

# ì›Œí¬í”Œë¡œìš° ê¶Œí•œ ì„¤ì •
permissions:
  contents: read
  actions: write